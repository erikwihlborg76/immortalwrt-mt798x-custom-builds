name: openwrt-build-ex5601

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # ---- OPENWRT SOURCE ----
      OPENWRT_REPO_URL: "https://github.com/openwrt/openwrt.git"
      OPENWRT_TAG: "v24.10.3"

      # ---- CUSTOM REPO (patches, configs, files) ----
      CUSTOM_REPO: "https://github.com/erikwihlborg76/immortalwrt-ex5601-custom"
      CUSTOM_BRANCH: "main"

      # ---- TARGET / PROFILE ----
      OWRT_TARGET: "mediatek"
      OWRT_SUBTARGET: "filogic"
      PROFILE: "zyxel_ex5601-t0-ubootmod"
      BUILD_FLAVOR: "openwrt"

      # ---- MTK overlay feed control (kept consistent across both builds) ----
      MTK_FEED_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-6.6"
      MTK_FEED_BRANCH: "openwrt-24.10-6.6"
      MTK_OVERLAY_DIR: "${{ github.workspace }}/mtk-overlay"

      # ---- Workdir ----
      WORKDIR: "${{ github.workspace }}/openwrt"

    steps:
      - name: Checkout this build repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3 python3-distutils rsync unzip zlib1g-dev file wget \
            subversion swig libpython3-dev ccache

      - name: Fetch OpenWrt sources (v24.10.3)
        run: |
          git -c advice.detachedHead=false clone \
            --depth 1 --branch "${OPENWRT_TAG}" \
            "${OPENWRT_REPO_URL}" "${WORKDIR}"

      - name: Pull your custom repo (patches, configs, files)
        run: |
          git clone --depth 1 --branch "${CUSTOM_BRANCH}" \
            "${CUSTOM_REPO}" "${{ github.workspace }}/custom"

      - name: Prepare MTK private feed (overlay from padavanonly)
        run: |
          set -eu
          rm -rf "${MTK_OVERLAY_DIR}"
          mkdir -p "${MTK_OVERLAY_DIR}"
          git clone --depth 1 --branch "${MTK_FEED_BRANCH}" \
            "${MTK_FEED_REPO}" "${{ github.workspace }}/mtk-src"
          rsync -a "${{ github.workspace }}/mtk-src/package/mtk/drivers/" "${MTK_OVERLAY_DIR}/drivers/" || true
          rsync -a "${{ github.workspace }}/mtk-src/package/mtk/applications/" "${MTK_OVERLAY_DIR}/applications/" || true
          echo "Prepared overlay from padavanonly."

      - name: Configure feeds (honor feeds.conf.custom + bind MTK overlay)
        run: |
          set -eu
          cd "${WORKDIR}"
          # Base feeds.conf
          if [ -f "${GITHUB_WORKSPACE}/feeds.conf.custom" ]; then
            echo "Using feeds.conf.custom"
            cp "${GITHUB_WORKSPACE}/feeds.conf.custom" feeds.conf
          else
            cp feeds.conf.default feeds.conf
          fi
          # Append local MTK overlay if present
          if [ -d "${MTK_OVERLAY_DIR}" ] && [ "$(find "${MTK_OVERLAY_DIR}" -type f | wc -l)" -gt 0 ]; then
            echo "src-link mtk_overlay ${MTK_OVERLAY_DIR}" >> feeds.conf
            echo "Added mtk_overlay feed."
          else
            echo "No MTK overlay content found; not adding mtk_overlay feed."
          fi
          # Update/install feeds (overlay first if present)
          ./scripts/feeds update -a
          if grep -q '^src-link mtk_overlay ' feeds.conf; then
            ./scripts/feeds install -a -p mtk_overlay || true
          fi
          ./scripts/feeds install -a || true

      - name: Apply tree-level patches (optional)
        run: |
          set -eu
          cd "${WORKDIR}"
          CORE_PATCH_DIR="${GITHUB_WORKSPACE}/custom/patches-core"
          if [ -d "${CORE_PATCH_DIR}" ]; then
            for p in "${CORE_PATCH_DIR}/"*.patch; do
              [ -e "$p" ] || continue
              echo "Applying core patch: $(basename "$p")"
              patch -p1 --forward < "$p"
            done
          else
            echo "No core patches directory — skipping."
          fi

      - name: Apply generic per-package overlays to WORKDIR (optional)
        run: |
          set -eu
          if [ -d "${GITHUB_WORKSPACE}/custom/package-patches/package" ]; then
            echo "Overlaying custom package files into WORKDIR/package/"
            rsync -a "${GITHUB_WORKSPACE}/custom/package-patches/package/" "${WORKDIR}/package/"
          else
            echo "No generic package overlays found — skipping."
          fi

      - name: Apply custom MTK patches (driver+apps) to feed or tree
        run: |
          set -eu
          CUSTOM_ROOT="${GITHUB_WORKSPACE}/custom"
          # Choose destination: overlay feed (if present) else WORKDIR/package/mtk
          if [ -d "${MTK_OVERLAY_DIR}/drivers" ] || [ -d "${MTK_OVERLAY_DIR}/applications" ]; then
            DEST_ROOT="${MTK_OVERLAY_DIR}"
            echo "MTK overlay detected → applying MTK patches to overlay feed."
          else
            DEST_ROOT="${WORKDIR}/package/mtk"
            echo "No MTK overlay → applying MTK patches to WORKDIR/package/mtk."
          fi

          # 1) mt_wifi DRIVER patches
          SRC_MT_WIFI_PATCHES="${CUSTOM_ROOT}/package-patches/package/mtk/drivers/mt_wifi/patches"
          DST_MT_WIFI_DIR="$(find "${DEST_ROOT}/drivers" -maxdepth 2 -type d -name mt_wifi -print -quit || true)"
          if [ -n "${DST_MT_WIFI_DIR}" ] && [ -d "${SRC_MT_WIFI_PATCHES}" ]; then
            mkdir -p "${DST_MT_WIFI_DIR}/patches"
            echo "Copying mt_wifi driver patches into: ${DST_MT_WIFI_DIR}/patches"
            rsync -a "${SRC_MT_WIFI_PATCHES}/" "${DST_MT_WIFI_DIR}/patches/"
          else
            echo "NOTE: mt_wifi driver target or source patches not found."
            echo "  DST: ${DST_MT_WIFI_DIR:-<none>}  SRC: ${SRC_MT_WIFI_PATCHES:-<none>}"
          fi

          # 2) mtwifi-cfg USERLAND overlay
          SRC_MTWIFI_CFG_OVERLAY="${CUSTOM_ROOT}/package-patches/package/mtk/applications/mtwifi-cfg"
          DST_MTWIFI_CFG_DIR="$(find "${DEST_ROOT}/applications" -maxdepth 2 -type d -name mtwifi-cfg -print -quit || true)"
          if [ -n "${DST_MTWIFI_CFG_DIR}" ] && [ -d "${SRC_MTWIFI_CFG_OVERLAY}" ]; then
            echo "Overlaying mtwifi-cfg into: ${DST_MTWIFI_CFG_DIR}"
            rsync -a "${SRC_MTWIFI_CFG_OVERLAY}/" "${DST_MTWIFI_CFG_DIR}/"
          else
            echo "No mtwifi-cfg overlay provided or target not found — skipping."
          fi

      - name: Inject .config (prefers specific, then generic)
        run: |
          set -eu
          cd "${WORKDIR}"
          if [ -f "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.${BUILD_FLAVOR}.config" ]; then
            cp "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.${BUILD_FLAVOR}.config" .config
          elif [ -f "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.config" ]; then
            cp "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.config" .config
          else
            echo "ERROR: No ${PROFILE}.config found in custom/configs/"
            exit 1
          fi
          make defconfig

      - name: Rootfs overlay (optional)
        run: |
          set -eu
          if [ -d "${GITHUB_WORKSPACE}/custom/files" ]; then
            rsync -a "${GITHUB_WORKSPACE}/custom/files/" "${WORKDIR}/files/"
          fi

      - name: Build firmware
        run: |
          cd "${WORKDIR}"
          make download -j8
          make -j"$(nproc)" V=sc

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -a "${WORKDIR}/bin/targets/${OWRT_TARGET}/${OWRT_SUBTARGET}/"* artifacts/ || true
          mkdir -p artifacts/packages
          cp -a "${WORKDIR}/bin/packages" artifacts/packages/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.BUILD_FLAVOR }}-${{ env.PROFILE }}-${{ env.BUILD_DATE }}
          path: artifacts/
          compression-level: 9
          if-no-files-found: warn

      - name: Set build date
        run: echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          fail_on_unmatched_files: false
