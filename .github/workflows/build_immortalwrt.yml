name: immortalwrt-build-ex5601

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # ---- IMMORTALWRT SOURCE ----
      REPO_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
      BRANCH: "openwrt-24.10-6.6"

      # ---- CUSTOM REPO (patches, configs, files) ----
      CUSTOM_REPO: "https://github.com/erikwihlborg76/ex5601-custom-builds"
      CUSTOM_BRANCH: "main"

      # ---- TARGET / PROFILE ----
      OWRT_TARGET: "mediatek"
      OWRT_SUBTARGET: "filogic"
      PROFILE: "zyxel_ex5601-t0-ubootmod"
      BUILD_FLAVOR: "immortalwrt"

      # ---- Workdir ----
      WORKDIR: "${{ github.workspace }}/openwrt"

      # ---- Repro / ccache ----
      CCACHE_DIR: "${{ github.workspace }}/.ccache"
      CCACHE_COMPRESS: "1"
      SOURCE_DATE_EPOCH: "1704067200"  # 2024-01-01 (repro seed)

    steps:
      - name: Set build date early (for artifact name)
        run: echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Checkout orchestration repo (this repo)
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache/CodeQL
          sudo apt-get purge -y 'azure-cli' 'mono-devel' || true
          sudo apt-get autoremove -y
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3 python3-distutils rsync unzip zlib1g-dev file wget \
            subversion swig libpython3-dev ccache

      - name: Fetch ImmortalWrt sources
        run: |
          git -c advice.detachedHead=false clone \
            --single-branch --branch "${BRANCH}" \
            --depth 1 --filter=blob:none \
            "${REPO_URL}" "${WORKDIR}"

      - name: Pull your custom repo (patches, configs, files)
        run: |
          git clone --depth 1 --branch "${CUSTOM_BRANCH}" \
            "${CUSTOM_REPO}" "${{ github.workspace }}/custom"

      # -------------------- CACHES --------------------

      - name: Cache downloads (dl/)
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/dl
          key: dl-${{ runner.os }}-${{ env.BRANCH }}-${{ hashFiles('feeds.conf*', 'custom/configs/**') }}
          restore-keys: |
            dl-${{ runner.os }}-${{ env.BRANCH }}-
            dl-${{ runner.os }}-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ env.BRANCH }}-${{ env.PROFILE }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.BRANCH }}-${{ env.PROFILE }}-
            ccache-${{ runner.os }}-${{ env.BRANCH }}-

      - name: Cache toolchain & staging_dir
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKDIR }}/staging_dir
            ${{ env.WORKDIR }}/build_dir/host
            ${{ env.WORKDIR }}/build_dir/toolchain-*
          key: toolchain-${{ runner.os }}-${{ env.BRANCH }}-${{ env.OWRT_TARGET }}-${{ env.OWRT_SUBTARGET }}-${{ hashFiles('custom/configs/**') }}
          restore-keys: |
            toolchain-${{ runner.os }}-${{ env.BRANCH }}-${{ env.OWRT_TARGET }}-${{ env.OWRT_SUBTARGET }}-
            toolchain-${{ runner.os }}-${{ env.BRANCH }}-

      # -------------------- FEEDS --------------------

      - name: Configure feeds (prefer feeds.conf.custom)
        run: |
          set -eu
          cd "${WORKDIR}"
          if [ -f "${GITHUB_WORKSPACE}/feeds.conf.custom" ]; then
            cp "${GITHUB_WORKSPACE}/feeds.conf.custom" feeds.conf
          else
            cp feeds.conf.default feeds.conf
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a || true

      # -------------------- PATCH ALL (ROOT) --------------------
      # Apply every *.patch or *.diff under custom/patches (recursively).
      # Strategy: git am (mailbox) -> fallback: git apply -p0/-p1/-p2
      - name: Apply all patches from custom/patches
        run: |
          set -eu
          cd "${WORKDIR}"
          PATCH_ROOT="${GITHUB_WORKSPACE}/custom/patches"
          if [ ! -d "${PATCH_ROOT}" ]; then
            echo "No custom/patches directory; skipping."
            exit 0
          fi

          git config user.email "ci@localhost"
          git config user.name  "CI"

          # Gather patches deterministically
          mapfile -t PATCHES < <(find -L "${PATCH_ROOT}" -type f \( -iname '*.patch' -o -iname '*.diff' \) | sort)
          if [ "${#PATCHES[@]}" -eq 0 ]; then
            echo "No patch files found under ${PATCH_ROOT}; skipping."
            exit 0
          fi

          echo "Found ${#PATCHES[@]} patch(es). Applying now:"
          for p in "${PATCHES[@]}"; do
            echo " -> $(realpath --relative-to="${PATCH_ROOT}" "$p")"
            # Normalize CRLF
            sed -i 's/\r$//' "$p"

            # Try git am first (best for format-patch)
            if git am --keep-cr --3way --whitespace=fix "$p"; then
              continue
            fi

            # Fallback to git apply with varying strip levels
            git am --abort || true
            applied=0
            for STRIP in 0 1 2; do
              if git apply --check --whitespace=fix -p${STRIP} "$p"; then
                git apply --whitespace=fix -p${STRIP} "$p"
                git add -A
                git commit -m "Apply $(basename "$p") via git apply -p${STRIP}"
                applied=1
                break
              fi
            done

            if [ $applied -eq 0 ]; then
              echo "ERROR: Failed to apply patch: $p"
              exit 1
            fi
          done

      # -------------------- CONFIG & BUILD --------------------

      - name: Inject .config (prefers specific, then generic)
        run: |
          set -eu
          cd "${WORKDIR}"
          if [ -f "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.${BUILD_FLAVOR}.config" ]; then
            cp "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.${BUILD_FLAVOR}.config" .config
          elif [ -f "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.config" ]; then
            cp "${GITHUB_WORKSPACE}/custom/configs/${PROFILE}.config" .config
          else
            echo "ERROR: No ${PROFILE}.config found in custom/configs/"
            exit 1
          fi
          # Ensure ccache is enabled
          grep -q '^CONFIG_CCACHE=y' .config || echo 'CONFIG_CCACHE=y' >> .config
          make defconfig
          ./scripts/diffconfig.sh > .config.diff || true

      - name: Rootfs overlay (optional)
        run: |
          set -eu
          if [ -d "${GITHUB_WORKSPACE}/custom/files" ]; then
            rsync -a "${GITHUB_WORKSPACE}/custom/files/" "${WORKDIR}/files/"
          fi

      - name: Build firmware
        env:
          MAKEFLAGS: "-j$(nproc)"
        run: |
          set -eu
          cd "${WORKDIR}"
          # Download (retry once if mirrors hiccup)
          make download -j"$(nproc)" || make download -j1 V=s
          df -h
          # Capture build log
          ( time make -j"$(nproc)" V=sc ) 2>&1 | tee build.log
          grep -q "^make\[[0-9]\+\]: Leaving directory" build.log || {
            echo "Build likely failed; tailing log:"; tail -n 2000 build.log; exit 1;
          }

      # -------------------- ARTIFACTS --------------------

      - name: Collect artifacts
        run: |
          set -eu
          mkdir -p artifacts
          cp -a "${WORKDIR}/bin/targets/${OWRT_TARGET}/${OWRT_SUBTARGET}/"* artifacts/ || true
          mkdir -p artifacts/packages
          cp -a "${WORKDIR}/bin/packages" artifacts/packages/ || true
          # Configs and logs
          cp -a "${WORKDIR}/.config"        artifacts/ || true
          cp -a "${WORKDIR}/.config.diff"   artifacts/ || true
          cp -a "${WORKDIR}/feeds.conf"     artifacts/ || true
          cp -a "${WORKDIR}/build.log"      artifacts/ || true
          # Checksums
          (cd artifacts && \
            find . -type f \( -name '*.bin' -o -name '*.tar' -o -name '*.itb' -o -name '*.img' -o -name '*.ipk' \) -print0 \
            | xargs -0 sha256sum > SHA256SUMS.txt) || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.BUILD_FLAVOR }}-${{ env.PROFILE }}-${{ env.BUILD_DATE }}
          path: artifacts/
          compression-level: 9
          if-no-files-found: warn
          retention-days: 14

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ env.BUILD_FLAVOR }}-${{ env.PROFILE }}-${{ github.run_id }}
          path: |
            ${{ env.WORKDIR }}/.config
            ${{ env.WORKDIR }}/.config.diff
            ${{ env.WORKDIR }}/feeds.conf
            ${{ env.WORKDIR }}/build.log
            ${{ env.WORKDIR }}/logs
            ${{ env.WORKDIR }}/tmp/.packageinfo
            ${{ env.WORKDIR }}/build_dir/logs
          if-no-files-found: ignore

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          fail_on_unmatched_files: false
